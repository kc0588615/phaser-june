"use strict";(globalThis.webpackChunkwiki=globalThis.webpackChunkwiki||[]).push([[60489],{28453(e,n,t){t.d(n,{R:()=>r,x:()=>c});var s=t(96540);const i={},a=s.createContext(i);function r(e){const n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(a.Provider,{value:n},e.children)}},53703(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"architecture/eventbus-display","title":"EventBus & Display Architecture","description":"How React and Phaser communicate via the EventBus pattern","source":"@site/docs/architecture/eventbus-display.md","sourceDirName":"architecture","slug":"/architecture/eventbus-display","permalink":"/phaser-june/docs/architecture/eventbus-display","draft":false,"unlisted":false,"editUrl":"https://github.com/kc0588615/phaser-june/tree/main/wiki/docs/architecture/eventbus-display.md","tags":[{"inline":true,"label":"architecture","permalink":"/phaser-june/docs/tags/architecture"},{"inline":true,"label":"eventbus","permalink":"/phaser-june/docs/tags/eventbus"},{"inline":true,"label":"phaser","permalink":"/phaser-june/docs/tags/phaser"},{"inline":true,"label":"react","permalink":"/phaser-june/docs/tags/react"}],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1,"title":"EventBus & Display Architecture","description":"How React and Phaser communicate via the EventBus pattern","tags":["architecture","eventbus","phaser","react"]},"sidebar":"docsSidebar","previous":{"title":"Architecture","permalink":"/phaser-june/docs/category/architecture"},"next":{"title":"Game Reactivity Guide","permalink":"/phaser-june/docs/architecture/game-reactivity"}}');var i=t(74848),a=t(28453);const r={sidebar_position:1,title:"EventBus & Display Architecture",description:"How React and Phaser communicate via the EventBus pattern",tags:["architecture","eventbus","phaser","react"]},c="EventBus and Display System Architecture",l={},o=[{value:"The Fundamental Challenge",id:"the-fundamental-challenge",level:2},{value:"EventBus Architecture",id:"eventbus-architecture",level:2},{value:"Core Implementation",id:"core-implementation",level:3},{value:"Event Type Definitions",id:"event-type-definitions",level:3},{value:"Display System Layout",id:"display-system-layout",level:2},{value:"Component Hierarchy",id:"component-hierarchy",level:3},{value:"Layout Code",id:"layout-code",level:3},{value:"Key Communication Flows",id:"key-communication-flows",level:2},{value:"1. Location Selection (React \u2192 Phaser)",id:"1-location-selection-react--phaser",level:3},{value:"2. Clue Reveal (Phaser \u2192 React)",id:"2-clue-reveal-phaser--react",level:3},{value:"Critical Pattern: Component Mounting",id:"critical-pattern-component-mounting",level:2},{value:"Event Cleanup",id:"event-cleanup",level:2},{value:"Adding New Events",id:"adding-new-events",level:2},{value:"Debugging Tips",id:"debugging-tips",level:2},{value:"Log All Events",id:"log-all-events",level:3},{value:"Track Component Mount Status",id:"track-component-mount-status",level:3},{value:"Related Documentation",id:"related-documentation",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"eventbus-and-display-system-architecture",children:"EventBus and Display System Architecture"})}),"\n",(0,i.jsxs)(n.p,{children:["The Phaser-June project uses a ",(0,i.jsx)(n.strong,{children:"hybrid React-Phaser architecture"})," with an EventBus system for cross-framework communication. This guide explains the core patterns that make the application reactive."]}),"\n",(0,i.jsx)(n.h2,{id:"the-fundamental-challenge",children:"The Fundamental Challenge"}),"\n",(0,i.jsx)(n.p,{children:"React and Phaser operate in fundamentally different paradigms:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Aspect"}),(0,i.jsx)(n.th,{children:"React"}),(0,i.jsx)(n.th,{children:"Phaser"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Rendering"})}),(0,i.jsx)(n.td,{children:"Virtual DOM, declarative"}),(0,i.jsx)(n.td,{children:"Canvas, imperative"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"State"})}),(0,i.jsx)(n.td,{children:"useState/useReducer"}),(0,i.jsx)(n.td,{children:"Scene properties"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Lifecycle"})}),(0,i.jsx)(n.td,{children:"Component mount/unmount"}),(0,i.jsx)(n.td,{children:"Scene create/update/shutdown"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Updates"})}),(0,i.jsx)(n.td,{children:"Re-render on state change"}),(0,i.jsx)(n.td,{children:"Game loop (60fps)"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["They cannot directly access each other's state. The ",(0,i.jsx)(n.strong,{children:"EventBus"})," bridges this gap."]}),"\n",(0,i.jsx)(n.h2,{id:"eventbus-architecture",children:"EventBus Architecture"}),"\n",(0,i.jsx)(n.h3,{id:"core-implementation",children:"Core Implementation"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Location:"})," ",(0,i.jsx)(n.code,{children:"src/game/EventBus.ts"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"class TypedEventBus extends Phaser.Events.EventEmitter {\n  emit<K extends keyof EventPayloads>(\n    event: K,\n    ...args: [EventPayloads[K]]\n  ): boolean {\n    return super.emit(event, ...args);\n  }\n\n  on<K extends keyof EventPayloads>(\n    event: K,\n    fn: (arg: EventPayloads[K]) => void,\n    context?: any\n  ): this {\n    return super.on(event, fn, context);\n  }\n}\n\nexport const EventBus = new TypedEventBus();\n"})}),"\n",(0,i.jsx)(n.p,{children:"The EventBus extends Phaser's EventEmitter with TypeScript generics, ensuring type safety for all event payloads."}),"\n",(0,i.jsx)(n.h3,{id:"event-type-definitions",children:"Event Type Definitions"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"export interface EventPayloads {\n  'current-scene-ready': Phaser.Scene;\n\n  'cesium-location-selected': {\n    lon: number;\n    lat: number;\n    habitats: string[];\n    species: Species[];\n    rasterHabitats: RasterHabitatResult[];\n  };\n\n  'clue-revealed': CluePayload;\n\n  'new-game-started': {\n    speciesName: string;\n    speciesId: number;\n    totalSpecies: number;\n    currentIndex: number;\n  };\n\n  'species-guess-submitted': {\n    guessedName: string;\n    speciesId: number;\n    isCorrect: boolean;\n    actualName: string;\n  };\n\n  'all-species-completed': { totalSpecies: number };\n  'game-reset': undefined;\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"display-system-layout",children:"Display System Layout"}),"\n",(0,i.jsx)(n.h3,{id:"component-hierarchy",children:"Component Hierarchy"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"MainAppLayout\n\u251c\u2500\u2500 Top Section (60% height)\n\u2502   \u251c\u2500\u2500 CesiumMap (before game start)\n\u2502   \u2514\u2500\u2500 PhaserGame (after game start)\n\u2514\u2500\u2500 Bottom Section (40% height)\n    \u2514\u2500\u2500 SpeciesPanel\n        \u251c\u2500\u2500 SpeciesHeaderCard\n        \u251c\u2500\u2500 DenseClueGrid\n        \u2514\u2500\u2500 ClueSheet\n"})}),"\n",(0,i.jsx)(n.h3,{id:"layout-code",children:"Layout Code"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Location:"})," ",(0,i.jsx)(n.code,{children:"src/MainAppLayout.tsx"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"const appStyle: React.CSSProperties = {\n  display: 'flex',\n  flexDirection: 'column',\n  width: '100vw',\n  height: '100vh',\n  overflow: 'hidden'\n};\n\nconst cesiumContainerStyle: React.CSSProperties = {\n  width: '100%',\n  height: cesiumMinimized ? '0%' : '30%',\n  transition: 'height 0.3s ease-in-out',\n};\n"})}),"\n",(0,i.jsx)(n.h2,{id:"key-communication-flows",children:"Key Communication Flows"}),"\n",(0,i.jsx)(n.h3,{id:"1-location-selection-react--phaser",children:"1. Location Selection (React \u2192 Phaser)"}),"\n",(0,i.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant User\n    participant CesiumMap\n    participant EventBus\n    participant Game\n\n    User->>CesiumMap: Click on globe\n    CesiumMap->>EventBus: emit('cesium-location-selected', data)\n    EventBus->>Game: initializeBoardFromCesium(data)\n    Game->>Game: Create puzzle board with species"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"CesiumMap.tsx:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"EventBus.emit('cesium-location-selected', {\n  lon: longitude,\n  lat: latitude,\n  habitats: habitatList,\n  species: speciesResult.species,\n  rasterHabitats: rasterHabitats\n});\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Game.ts:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"create() {\n  EventBus.on('cesium-location-selected', this.initializeBoardFromCesium, this);\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"2-clue-reveal-phaser--react",children:"2. Clue Reveal (Phaser \u2192 React)"}),"\n",(0,i.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant Game\n    participant EventBus\n    participant SpeciesPanel\n\n    Game->>Game: Match detected\n    Game->>EventBus: emit('clue-revealed', clueData)\n    EventBus->>SpeciesPanel: handleClueRevealed(clueData)\n    SpeciesPanel->>SpeciesPanel: Update UI, show toast"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Game.ts:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"EventBus.emit('clue-revealed', {\n  category: clueCategory,\n  clue: clueText,\n  name: clueConfig.categories[clueCategory].displayName,\n  color: gemColor,\n  icon: clueConfig.categories[clueCategory].icon\n});\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"SpeciesPanel.tsx:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"useEffect(() => {\n  const handleClueRevealed = (clueData: CluePayload) => {\n    setClues(prev => [...prev, clueData]);\n    showClueToast(clueData);\n  };\n\n  EventBus.on('clue-revealed', handleClueRevealed);\n\n  return () => {\n    EventBus.off('clue-revealed', handleClueRevealed);\n  };\n}, []);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"critical-pattern-component-mounting",children:"Critical Pattern: Component Mounting"}),"\n",(0,i.jsx)(n.admonition,{title:"Keep Components Mounted",type:"warning",children:(0,i.jsx)(n.p,{children:"Components that listen to EventBus events must remain in the DOM. Use CSS visibility instead of conditional rendering."})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Correct:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"<div style={{ display: showMap ? 'block' : 'none' }}>\n  <CesiumMap />\n</div>\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Incorrect:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"{showMap && <CesiumMap />}  // Unmounts component, loses listeners!\n"})}),"\n",(0,i.jsx)(n.h2,{id:"event-cleanup",children:"Event Cleanup"}),"\n",(0,i.jsx)(n.p,{children:"Always remove listeners in cleanup functions to prevent memory leaks:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"useEffect(() => {\n  const handler = (data: PayloadType) => { /* ... */ };\n  EventBus.on('event-name', handler);\n\n  return () => {\n    EventBus.off('event-name', handler);  // Critical!\n  };\n}, []);\n"})}),"\n",(0,i.jsx)(n.p,{children:"In Phaser scenes:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"shutdown() {\n  EventBus.off('cesium-location-selected', this.initializeBoardFromCesium, this);\n  EventBus.off('layout-changed', this.handleLayoutChange, this);\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"adding-new-events",children:"Adding New Events"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Define the payload type"})," in ",(0,i.jsx)(n.code,{children:"EventPayloads"})," interface"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Emit from source"})," (React component or Phaser scene)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Listen in target"})," (with proper cleanup)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Document the flow"})," for future maintainers"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// 1. Define in EventBus.ts\nexport interface EventPayloads {\n  'my-new-event': { data: string; count: number };\n}\n\n// 2. Emit\nEventBus.emit('my-new-event', { data: 'test', count: 5 });\n\n// 3. Listen\nEventBus.on('my-new-event', (payload) => {\n  console.log(payload.data, payload.count);  // TypeScript knows the types!\n});\n"})}),"\n",(0,i.jsx)(n.h2,{id:"debugging-tips",children:"Debugging Tips"}),"\n",(0,i.jsx)(n.h3,{id:"log-all-events",children:"Log All Events"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"if (process.env.NODE_ENV === 'development') {\n  const originalEmit = EventBus.emit.bind(EventBus);\n  EventBus.emit = function(event, ...args) {\n    console.log(`[EventBus] ${event}`, ...args);\n    return originalEmit(event, ...args);\n  };\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"track-component-mount-status",children:"Track Component Mount Status"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"useEffect(() => {\n  console.log('Component mounted, setting up listeners');\n  return () => console.log('Component unmounting');\n}, []);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/docs/architecture/game-reactivity",children:"Game Reactivity Guide"})," - Resize handling and MVC pattern"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/docs/architecture/ui-display-system",children:"UI Display System"})," - Layout variables and responsive behavior"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);