"use strict";(globalThis.webpackChunkwiki=globalThis.webpackChunkwiki||[]).push([[52527],{28453(e,n,i){i.d(n,{R:()=>r,x:()=>l});var t=i(96540);const a={},s=t.createContext(a);function r(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),t.createElement(s.Provider,{value:n},e.children)}},53120(e,n,i){i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>u,frontMatter:()=>r,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"tutorials/cesium-integration","title":"Cesium Integration","description":"Working with the 3D globe and geospatial data","source":"@site/docs/tutorials/cesium-integration.md","sourceDirName":"tutorials","slug":"/tutorials/cesium-integration","permalink":"/phaser-june/docs/tutorials/cesium-integration","draft":false,"unlisted":false,"editUrl":"https://github.com/kc0588615/phaser-june/tree/main/wiki/docs/tutorials/cesium-integration.md","tags":[{"inline":true,"label":"tutorial","permalink":"/phaser-june/docs/tags/tutorial"},{"inline":true,"label":"cesium","permalink":"/phaser-june/docs/tags/cesium"},{"inline":true,"label":"geospatial","permalink":"/phaser-june/docs/tags/geospatial"}],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"Cesium Integration","description":"Working with the 3D globe and geospatial data","tags":["tutorial","cesium","geospatial"]},"sidebar":"docsSidebar","previous":{"title":"React-Phaser Bridge","permalink":"/phaser-june/docs/tutorials/react-phaser-bridge"},"next":{"title":"Architecture","permalink":"/phaser-june/docs/category/architecture"}}');var a=i(74848),s=i(28453);const r={sidebar_position:3,title:"Cesium Integration",description:"Working with the 3D globe and geospatial data",tags:["tutorial","cesium","geospatial"]},l="Tutorial: Cesium Integration",o={},c=[{value:"Overview",id:"overview",level:2},{value:"Cesium Setup",id:"cesium-setup",level:2},{value:"Component Structure",id:"component-structure",level:3},{value:"Ion Token Setup",id:"ion-token-setup",level:3},{value:"Click Handling",id:"click-handling",level:2},{value:"Capturing Globe Clicks",id:"capturing-globe-clicks",level:3},{value:"Querying Species Data",id:"querying-species-data",level:3},{value:"Supabase Integration",id:"supabase-integration",level:2},{value:"Species Query RPC",id:"species-query-rpc",level:3},{value:"The Database Function",id:"the-database-function",level:3},{value:"TiTiler Raster Integration",id:"titiler-raster-integration",level:2},{value:"Querying Habitat Rasters",id:"querying-habitat-rasters",level:3},{value:"Habitat Legend Mapping",id:"habitat-legend-mapping",level:3},{value:"Visualizing Selected Area",id:"visualizing-selected-area",level:2},{value:"Drawing a Circle",id:"drawing-a-circle",level:3},{value:"Highlighting Habitat Polygons",id:"highlighting-habitat-polygons",level:3},{value:"Camera Controls",id:"camera-controls",level:2},{value:"Flying to Location",id:"flying-to-location",level:3},{value:"Setting Initial View",id:"setting-initial-view",level:3},{value:"Performance Tips",id:"performance-tips",level:2},{value:"Exercise: Add a Location Marker",id:"exercise-add-a-location-marker",level:2},{value:"Summary",id:"summary",level:2},{value:"Related Documentation",id:"related-documentation",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"tutorial-cesium-integration",children:"Tutorial: Cesium Integration"})}),"\n",(0,a.jsx)(n.p,{children:"Learn how Critter Connect integrates CesiumJS for 3D globe visualization and geospatial queries."}),"\n",(0,a.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,a.jsx)(n.p,{children:"CesiumJS provides the 3D globe where players select locations. When a player clicks the globe:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Coordinates are captured"}),"\n",(0,a.jsx)(n.li,{children:"Species at that location are queried from Supabase"}),"\n",(0,a.jsx)(n.li,{children:"Habitat data is fetched from TiTiler (raster service)"}),"\n",(0,a.jsx)(n.li,{children:"Data is sent to the game via EventBus"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"cesium-setup",children:"Cesium Setup"}),"\n",(0,a.jsx)(n.h3,{id:"component-structure",children:"Component Structure"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Location:"})," ",(0,a.jsx)(n.code,{children:"src/components/CesiumMap.tsx"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"import { Viewer, Entity, CesiumComponentRef } from 'resium';\nimport { Viewer as CesiumViewer, Cartesian3, Ion } from 'cesium';\n\nexport function CesiumMap() {\n  const viewerRef = useRef<CesiumComponentRef<CesiumViewer>>(null);\n\n  return (\n    <Viewer\n      ref={viewerRef}\n      full\n      timeline={false}\n      animation={false}\n      homeButton={false}\n      sceneModePicker={false}\n    >\n      {/* Entity layers added here */}\n    </Viewer>\n  );\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"ion-token-setup",children:"Ion Token Setup"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"// Set before Viewer renders\nIon.defaultAccessToken = process.env.NEXT_PUBLIC_CESIUM_ION_TOKEN!;\n"})}),"\n",(0,a.jsx)(n.h2,{id:"click-handling",children:"Click Handling"}),"\n",(0,a.jsx)(n.h3,{id:"capturing-globe-clicks",children:"Capturing Globe Clicks"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"useEffect(() => {\n  const viewer = viewerRef.current?.cesiumElement;\n  if (!viewer) return;\n\n  const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);\n\n  handler.setInputAction((click: { position: Cartesian2 }) => {\n    const cartesian = viewer.camera.pickEllipsoid(\n      click.position,\n      viewer.scene.globe.ellipsoid\n    );\n\n    if (cartesian) {\n      const cartographic = Cesium.Cartographic.fromCartesian(cartesian);\n      const longitude = Cesium.Math.toDegrees(cartographic.longitude);\n      const latitude = Cesium.Math.toDegrees(cartographic.latitude);\n\n      handleLocationSelect(longitude, latitude);\n    }\n  }, Cesium.ScreenSpaceEventType.LEFT_CLICK);\n\n  return () => handler.destroy();\n}, []);\n"})}),"\n",(0,a.jsx)(n.h3,{id:"querying-species-data",children:"Querying Species Data"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"async function handleLocationSelect(lon: number, lat: number) {\n  // 1. Query species at location\n  const speciesResult = await getSpeciesAtLocation(lon, lat, SPECIES_RADIUS_METERS);\n\n  // 2. Query habitat raster data\n  const rasterHabitats = await getRasterHabitats(lon, lat);\n\n  // 3. Send to game\n  EventBus.emit('cesium-location-selected', {\n    lon,\n    lat,\n    species: speciesResult.species,\n    habitats: speciesResult.habitats,\n    rasterHabitats\n  });\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"supabase-integration",children:"Supabase Integration"}),"\n",(0,a.jsx)(n.h3,{id:"species-query-rpc",children:"Species Query RPC"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"// src/lib/speciesService.ts\nexport async function getSpeciesAtLocation(\n  lon: number,\n  lat: number,\n  radiusMeters: number\n): Promise<{ species: Species[]; habitats: string[] }> {\n  const { data, error } = await supabase.rpc('get_species_at_location', {\n    p_lon: lon,\n    p_lat: lat,\n    p_radius: radiusMeters\n  });\n\n  if (error) throw error;\n  return data;\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"the-database-function",children:"The Database Function"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"CREATE OR REPLACE FUNCTION get_species_at_location(\n  p_lon FLOAT,\n  p_lat FLOAT,\n  p_radius INT\n) RETURNS JSON AS $$\n  SELECT json_build_object(\n    'species', (\n      SELECT json_agg(s.*)\n      FROM icaa_species s\n      WHERE ST_DWithin(\n        s.geom,\n        ST_SetSRID(ST_MakePoint(p_lon, p_lat), 4326)::geography,\n        p_radius\n      )\n      LIMIT 10\n    ),\n    'habitats', (\n      SELECT array_agg(DISTINCT h.habitat_type)\n      FROM habitats h\n      WHERE ST_Intersects(\n        h.geom,\n        ST_Buffer(\n          ST_SetSRID(ST_MakePoint(p_lon, p_lat), 4326)::geography,\n          p_radius\n        )\n      )\n    )\n  );\n$$ LANGUAGE sql;\n"})}),"\n",(0,a.jsx)(n.h2,{id:"titiler-raster-integration",children:"TiTiler Raster Integration"}),"\n",(0,a.jsx)(n.h3,{id:"querying-habitat-rasters",children:"Querying Habitat Rasters"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"async function getRasterHabitats(lon: number, lat: number) {\n  const url = `${TITILER_BASE_URL}/cog/point/${lon},${lat}`;\n\n  const response = await fetch(url, {\n    method: 'GET',\n    headers: { 'Content-Type': 'application/json' }\n  });\n\n  const data = await response.json();\n\n  return data.values.map((value: number, index: number) => ({\n    habitat_type: HABITAT_LEGEND[value] || 'Unknown',\n    band: index,\n    value\n  }));\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"habitat-legend-mapping",children:"Habitat Legend Mapping"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"const HABITAT_LEGEND: Record<number, string> = {\n  100: 'Tropical Rainforest',\n  101: 'Temperate Forest',\n  200: 'Savanna',\n  300: 'Shrubland',\n  400: 'Grassland',\n  500: 'Wetland',\n  // ...\n};\n"})}),"\n",(0,a.jsx)(n.h2,{id:"visualizing-selected-area",children:"Visualizing Selected Area"}),"\n",(0,a.jsx)(n.h3,{id:"drawing-a-circle",children:"Drawing a Circle"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"const [selectedLocation, setSelectedLocation] = useState<{\n  lon: number;\n  lat: number;\n} | null>(null);\n\n// In JSX\n{selectedLocation && (\n  <Entity\n    position={Cartesian3.fromDegrees(\n      selectedLocation.lon,\n      selectedLocation.lat\n    )}\n    ellipse={{\n      semiMajorAxis: SPECIES_RADIUS_METERS,\n      semiMinorAxis: SPECIES_RADIUS_METERS,\n      material: Cesium.Color.CYAN.withAlpha(0.3),\n      outline: true,\n      outlineColor: Cesium.Color.CYAN\n    }}\n  />\n)}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"highlighting-habitat-polygons",children:"Highlighting Habitat Polygons"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"{habitatPolygons.map((polygon, index) => (\n  <Entity\n    key={index}\n    polygon={{\n      hierarchy: polygon.coordinates,\n      material: Cesium.Color.fromCssColorString(polygon.color).withAlpha(0.4),\n      outline: true,\n      outlineColor: Cesium.Color.WHITE\n    }}\n  />\n))}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"camera-controls",children:"Camera Controls"}),"\n",(0,a.jsx)(n.h3,{id:"flying-to-location",children:"Flying to Location"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"function flyToLocation(lon: number, lat: number) {\n  const viewer = viewerRef.current?.cesiumElement;\n  if (!viewer) return;\n\n  viewer.camera.flyTo({\n    destination: Cartesian3.fromDegrees(lon, lat, 1000000),\n    duration: 2,\n    orientation: {\n      heading: 0,\n      pitch: Cesium.Math.toRadians(-90),\n      roll: 0\n    }\n  });\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"setting-initial-view",children:"Setting Initial View"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"useEffect(() => {\n  const viewer = viewerRef.current?.cesiumElement;\n  if (!viewer) return;\n\n  viewer.camera.setView({\n    destination: Cartesian3.fromDegrees(-95, 40, 15000000)\n  });\n}, []);\n"})}),"\n",(0,a.jsx)(n.h2,{id:"performance-tips",children:"Performance Tips"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Limit entities:"})," Remove old visualization entities when new ones are added"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Use primitives:"})," For many polygons, use ",(0,a.jsx)(n.code,{children:"PrimitiveCollection"})," instead of ",(0,a.jsx)(n.code,{children:"Entity"})]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Disable unneeded features:"})," Turn off timeline, animation, etc."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Lazy load Cesium:"})," Load Cesium assets only when the map is visible"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"exercise-add-a-location-marker",children:"Exercise: Add a Location Marker"}),"\n",(0,a.jsx)(n.p,{children:"Add a pulsing marker at the clicked location:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"{selectedLocation && (\n  <Entity\n    position={Cartesian3.fromDegrees(\n      selectedLocation.lon,\n      selectedLocation.lat\n    )}\n    point={{\n      pixelSize: 20,\n      color: Cesium.Color.RED,\n      outlineColor: Cesium.Color.WHITE,\n      outlineWidth: 3\n    }}\n    label={{\n      text: 'Selected',\n      font: '14px sans-serif',\n      verticalOrigin: Cesium.VerticalOrigin.BOTTOM,\n      pixelOffset: new Cesium.Cartesian2(0, -25)\n    }}\n  />\n)}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Cesium provides 3D globe visualization"}),"\n",(0,a.jsx)(n.li,{children:"Click events capture lat/lon coordinates"}),"\n",(0,a.jsx)(n.li,{children:"Supabase RPCs query species at location"}),"\n",(0,a.jsx)(n.li,{children:"TiTiler provides raster habitat data"}),"\n",(0,a.jsx)(n.li,{children:"EventBus sends combined data to game"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/docs/guides/map/habitat-highlight",children:"Habitat Highlight Guide"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/docs/guides/data/database-guide",children:"Database Guide"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}}}]);