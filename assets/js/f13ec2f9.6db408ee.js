"use strict";(globalThis.webpackChunkwiki=globalThis.webpackChunkwiki||[]).push([[99832],{28453(e,s,n){n.d(s,{R:()=>t,x:()=>c});var i=n(96540);const d={},r=i.createContext(d);function t(e){const s=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:t(e.components),i.createElement(r.Provider,{value:s},e.children)}},46688(e,s,n){n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>c,default:()=>x,frontMatter:()=>t,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"reference/database-schema","title":"Database Schema","description":"Postgres tables, Prisma models, and data types","source":"@site/docs/reference/database-schema.md","sourceDirName":"reference","slug":"/reference/database-schema","permalink":"/phaser-june/docs/reference/database-schema","draft":false,"unlisted":false,"editUrl":"https://github.com/kc0588615/phaser-june/tree/main/wiki/docs/reference/database-schema.md","tags":[{"inline":true,"label":"reference","permalink":"/phaser-june/docs/tags/reference"},{"inline":true,"label":"database","permalink":"/phaser-june/docs/tags/database"},{"inline":true,"label":"postgres","permalink":"/phaser-june/docs/tags/postgres"},{"inline":true,"label":"prisma","permalink":"/phaser-june/docs/tags/prisma"}],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"Database Schema","description":"Postgres tables, Prisma models, and data types","tags":["reference","database","postgres","prisma"]},"sidebar":"docsSidebar","previous":{"title":"Event Types Reference","permalink":"/phaser-june/docs/reference/event-types"},"next":{"title":"Environment Variables","permalink":"/phaser-june/docs/reference/env-vars"}}');var d=n(74848),r=n(28453);const t={sidebar_position:3,title:"Database Schema",description:"Postgres tables, Prisma models, and data types",tags:["reference","database","postgres","prisma"]},c="Database Schema Reference",l={},a=[{value:"Core Tables",id:"core-tables",level:2},{value:"icaa_species",id:"icaa_species",level:3},{value:"profiles",id:"profiles",level:3},{value:"game_sessions",id:"game_sessions",level:3},{value:"clue_discoveries",id:"clue_discoveries",level:3},{value:"species_discoveries",id:"species_discoveries",level:3},{value:"RPC Functions",id:"rpc-functions",level:2},{value:"get_species_at_location",id:"get_species_at_location",level:3},{value:"get_random_species",id:"get_random_species",level:3},{value:"record_clue_discovery",id:"record_clue_discovery",level:3},{value:"get_player_stats",id:"get_player_stats",level:3},{value:"TypeScript Types",id:"typescript-types",level:2},{value:"Indexes",id:"indexes",level:2},{value:"Row Level Security",id:"row-level-security",level:2},{value:"Related Documentation",id:"related-documentation",level:2}];function h(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(s.header,{children:(0,d.jsx)(s.h1,{id:"database-schema-reference",children:"Database Schema Reference"})}),"\n",(0,d.jsx)(s.p,{children:"Reference for Postgres tables, Prisma models, and TypeScript types."}),"\n",(0,d.jsx)(s.h2,{id:"core-tables",children:"Core Tables"}),"\n",(0,d.jsx)(s.h3,{id:"icaa_species",children:"icaa_species"}),"\n",(0,d.jsx)(s.p,{children:"Main species data table with taxonomy and characteristics."}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Column"}),(0,d.jsx)(s.th,{children:"Type"}),(0,d.jsx)(s.th,{children:"Description"})]})}),(0,d.jsxs)(s.tbody,{children:[(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"id"})}),(0,d.jsx)(s.td,{children:"integer"}),(0,d.jsx)(s.td,{children:"Primary key"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"common_name"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Common name"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"sci_name"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Scientific name"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"tax_comm"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Taxonomic comments"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"phylum"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Phylum classification"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"class"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Class classification"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"order_"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Order (note underscore)"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"family"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Family classification"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"genus"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Genus"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"geo_desc"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Geographic description"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"dist_comm"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Distribution comments"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"hab_desc"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Habitat description"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"hab_tags"})}),(0,d.jsx)(s.td,{children:"text[]"}),(0,d.jsx)(s.td,{children:"Habitat tags array"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"pattern"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Body pattern"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"color_prim"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Primary coloration"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"color_sec"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Secondary coloration"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"shape_desc"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Body shape"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"size_max"})}),(0,d.jsx)(s.td,{children:"numeric"}),(0,d.jsx)(s.td,{children:"Maximum size"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"weight_kg"})}),(0,d.jsx)(s.td,{children:"numeric"}),(0,d.jsx)(s.td,{children:"Weight in kg"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"behav_1"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Primary behavior"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"behav_2"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Secondary behavior"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"diet_type"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Diet classification"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"diet_prey"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Prey species"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"diet_flora"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Plant diet"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"life_desc1"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Life cycle description 1"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"life_desc2"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Life cycle description 2"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"lifespan"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Expected lifespan"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"maturity"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Age at maturity"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"repro_type"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Reproduction type"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"clutch_sz"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Clutch/litter size"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"cons_text"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Conservation description"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"threats"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Known threats"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"cons_code"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"IUCN status code"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"category"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"IUCN category"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"key_fact1"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Key fact 1"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"key_fact2"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Key fact 2"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"key_fact3"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Key fact 3"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"image_url"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Species image URL"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"geom"})}),(0,d.jsx)(s.td,{children:"geometry"}),(0,d.jsx)(s.td,{children:"PostGIS geometry (4326)"})]})]})]}),"\n",(0,d.jsx)(s.h3,{id:"profiles",children:"profiles"}),"\n",(0,d.jsx)(s.p,{children:"Player profiles linked to Supabase Auth."}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Column"}),(0,d.jsx)(s.th,{children:"Type"}),(0,d.jsx)(s.th,{children:"Description"})]})}),(0,d.jsxs)(s.tbody,{children:[(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"id"})}),(0,d.jsx)(s.td,{children:"uuid"}),(0,d.jsx)(s.td,{children:"Primary key (matches auth.users.id)"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"username"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Display name"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"avatar_url"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Profile image URL"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"created_at"})}),(0,d.jsx)(s.td,{children:"timestamptz"}),(0,d.jsx)(s.td,{children:"Account creation"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"updated_at"})}),(0,d.jsx)(s.td,{children:"timestamptz"}),(0,d.jsx)(s.td,{children:"Last update"})]})]})]}),"\n",(0,d.jsx)(s.h3,{id:"game_sessions",children:"game_sessions"}),"\n",(0,d.jsx)(s.p,{children:"Individual game session records."}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Column"}),(0,d.jsx)(s.th,{children:"Type"}),(0,d.jsx)(s.th,{children:"Description"})]})}),(0,d.jsxs)(s.tbody,{children:[(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"id"})}),(0,d.jsx)(s.td,{children:"uuid"}),(0,d.jsx)(s.td,{children:"Primary key"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"player_id"})}),(0,d.jsx)(s.td,{children:"uuid"}),(0,d.jsx)(s.td,{children:"FK to profiles.id"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"location_lon"})}),(0,d.jsx)(s.td,{children:"numeric"}),(0,d.jsx)(s.td,{children:"Longitude"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"location_lat"})}),(0,d.jsx)(s.td,{children:"numeric"}),(0,d.jsx)(s.td,{children:"Latitude"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"started_at"})}),(0,d.jsx)(s.td,{children:"timestamptz"}),(0,d.jsx)(s.td,{children:"Session start"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"ended_at"})}),(0,d.jsx)(s.td,{children:"timestamptz"}),(0,d.jsx)(s.td,{children:"Session end"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"score"})}),(0,d.jsx)(s.td,{children:"integer"}),(0,d.jsx)(s.td,{children:"Final score"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"species_found"})}),(0,d.jsx)(s.td,{children:"integer"}),(0,d.jsx)(s.td,{children:"Species identified count"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"total_species"})}),(0,d.jsx)(s.td,{children:"integer"}),(0,d.jsx)(s.td,{children:"Total species at location"})]})]})]}),"\n",(0,d.jsx)(s.h3,{id:"clue_discoveries",children:"clue_discoveries"}),"\n",(0,d.jsx)(s.p,{children:"Record of clues revealed during gameplay."}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Column"}),(0,d.jsx)(s.th,{children:"Type"}),(0,d.jsx)(s.th,{children:"Description"})]})}),(0,d.jsxs)(s.tbody,{children:[(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"id"})}),(0,d.jsx)(s.td,{children:"uuid"}),(0,d.jsx)(s.td,{children:"Primary key"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"session_id"})}),(0,d.jsx)(s.td,{children:"uuid"}),(0,d.jsx)(s.td,{children:"FK to game_sessions.id"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"species_id"})}),(0,d.jsx)(s.td,{children:"integer"}),(0,d.jsx)(s.td,{children:"FK to icaa_species.id"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"clue_type"})}),(0,d.jsx)(s.td,{children:"text"}),(0,d.jsx)(s.td,{children:"Category name"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"discovered_at"})}),(0,d.jsx)(s.td,{children:"timestamptz"}),(0,d.jsx)(s.td,{children:"Discovery timestamp"})]})]})]}),"\n",(0,d.jsx)(s.h3,{id:"species_discoveries",children:"species_discoveries"}),"\n",(0,d.jsx)(s.p,{children:"Record of correctly identified species."}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Column"}),(0,d.jsx)(s.th,{children:"Type"}),(0,d.jsx)(s.th,{children:"Description"})]})}),(0,d.jsxs)(s.tbody,{children:[(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"id"})}),(0,d.jsx)(s.td,{children:"uuid"}),(0,d.jsx)(s.td,{children:"Primary key"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"session_id"})}),(0,d.jsx)(s.td,{children:"uuid"}),(0,d.jsx)(s.td,{children:"FK to game_sessions.id"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"species_id"})}),(0,d.jsx)(s.td,{children:"integer"}),(0,d.jsx)(s.td,{children:"FK to icaa_species.id"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"guess_count"})}),(0,d.jsx)(s.td,{children:"integer"}),(0,d.jsx)(s.td,{children:"Attempts before correct"})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"discovered_at"})}),(0,d.jsx)(s.td,{children:"timestamptz"}),(0,d.jsx)(s.td,{children:"Discovery timestamp"})]})]})]}),"\n",(0,d.jsx)(s.h2,{id:"rpc-functions",children:"RPC Functions"}),"\n",(0,d.jsx)(s.h3,{id:"get_species_at_location",children:"get_species_at_location"}),"\n",(0,d.jsx)(s.p,{children:"Returns species within radius of a point."}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-sql",children:"CREATE OR REPLACE FUNCTION get_species_at_location(\n  p_lon FLOAT,\n  p_lat FLOAT,\n  p_radius INT DEFAULT 50000\n) RETURNS JSON AS $$\n  SELECT json_build_object(\n    'species', COALESCE((\n      SELECT json_agg(row_to_json(s))\n      FROM (\n        SELECT *\n        FROM icaa_species\n        WHERE ST_DWithin(\n          geom::geography,\n          ST_SetSRID(ST_MakePoint(p_lon, p_lat), 4326)::geography,\n          p_radius\n        )\n        ORDER BY RANDOM()\n        LIMIT 10\n      ) s\n    ), '[]'::json),\n    'habitats', COALESCE((\n      SELECT array_agg(DISTINCT hab)\n      FROM icaa_species,\n      LATERAL unnest(hab_tags) AS hab\n      WHERE ST_DWithin(\n        geom::geography,\n        ST_SetSRID(ST_MakePoint(p_lon, p_lat), 4326)::geography,\n        p_radius\n      )\n    ), ARRAY[]::text[])\n  );\n$$ LANGUAGE sql STABLE;\n"})}),"\n",(0,d.jsx)(s.p,{children:(0,d.jsx)(s.strong,{children:"Usage:"})}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-typescript",children:"const { data } = await supabase.rpc('get_species_at_location', {\n  p_lon: -95.5,\n  p_lat: 29.7,\n  p_radius: 50000\n});\n"})}),"\n",(0,d.jsx)(s.h3,{id:"get_random_species",children:"get_random_species"}),"\n",(0,d.jsx)(s.p,{children:"Returns random subset from species IDs."}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-sql",children:"CREATE OR REPLACE FUNCTION get_random_species(\n  species_ids INT[],\n  limit_count INT DEFAULT 5\n) RETURNS SETOF icaa_species AS $$\n  SELECT *\n  FROM icaa_species\n  WHERE id = ANY(species_ids)\n  ORDER BY RANDOM()\n  LIMIT limit_count;\n$$ LANGUAGE sql STABLE;\n"})}),"\n",(0,d.jsx)(s.h3,{id:"record_clue_discovery",children:"record_clue_discovery"}),"\n",(0,d.jsx)(s.p,{children:"Records a clue reveal event."}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-sql",children:"CREATE OR REPLACE FUNCTION record_clue_discovery(\n  p_session_id UUID,\n  p_species_id INT,\n  p_clue_type TEXT\n) RETURNS UUID AS $$\n  INSERT INTO clue_discoveries (session_id, species_id, clue_type)\n  VALUES (p_session_id, p_species_id, p_clue_type)\n  RETURNING id;\n$$ LANGUAGE sql;\n"})}),"\n",(0,d.jsx)(s.h3,{id:"get_player_stats",children:"get_player_stats"}),"\n",(0,d.jsx)(s.p,{children:"Returns aggregated player statistics."}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-sql",children:"CREATE OR REPLACE FUNCTION get_player_stats(p_player_id UUID)\nRETURNS JSON AS $$\n  SELECT json_build_object(\n    'total_games', COUNT(DISTINCT gs.id),\n    'total_species_found', COALESCE(SUM(gs.species_found), 0),\n    'total_score', COALESCE(SUM(gs.score), 0),\n    'unique_species', (\n      SELECT COUNT(DISTINCT species_id)\n      FROM species_discoveries sd\n      JOIN game_sessions gs2 ON sd.session_id = gs2.id\n      WHERE gs2.player_id = p_player_id\n    )\n  )\n  FROM game_sessions gs\n  WHERE gs.player_id = p_player_id;\n$$ LANGUAGE sql STABLE;\n"})}),"\n",(0,d.jsx)(s.h2,{id:"typescript-types",children:"TypeScript Types"}),"\n",(0,d.jsxs)(s.p,{children:[(0,d.jsx)(s.strong,{children:"Location:"})," ",(0,d.jsx)(s.code,{children:"src/types/database.ts"})]}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-typescript",children:"export interface Species {\n  id: number;\n  common_name: string;\n  sci_name: string;\n  phylum?: string;\n  class?: string;\n  order_?: string;\n  family?: string;\n  genus?: string;\n  geo_desc?: string;\n  dist_comm?: string;\n  hab_desc?: string;\n  hab_tags?: string[];\n  pattern?: string;\n  color_prim?: string;\n  color_sec?: string;\n  shape_desc?: string;\n  size_max?: number;\n  weight_kg?: number;\n  behav_1?: string;\n  behav_2?: string;\n  diet_type?: string;\n  diet_prey?: string;\n  diet_flora?: string;\n  life_desc1?: string;\n  life_desc2?: string;\n  lifespan?: string;\n  maturity?: string;\n  repro_type?: string;\n  clutch_sz?: string;\n  cons_text?: string;\n  threats?: string;\n  cons_code?: string;\n  category?: string;\n  key_fact1?: string;\n  key_fact2?: string;\n  key_fact3?: string;\n  image_url?: string;\n}\n\nexport interface GameSession {\n  id: string;\n  player_id: string;\n  location_lon: number;\n  location_lat: number;\n  started_at: string;\n  ended_at?: string;\n  score: number;\n  species_found: number;\n  total_species: number;\n}\n\nexport interface PlayerStats {\n  total_games: number;\n  total_species_found: number;\n  total_score: number;\n  unique_species: number;\n}\n"})}),"\n",(0,d.jsx)(s.h2,{id:"indexes",children:"Indexes"}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-sql",children:"-- Spatial index for location queries\nCREATE INDEX idx_icaa_species_geom ON icaa_species USING GIST (geom);\n\n-- Session lookups\nCREATE INDEX idx_game_sessions_player ON game_sessions (player_id);\nCREATE INDEX idx_game_sessions_dates ON game_sessions (started_at DESC);\n\n-- Discovery queries\nCREATE INDEX idx_clue_discoveries_session ON clue_discoveries (session_id);\nCREATE INDEX idx_species_discoveries_session ON species_discoveries (session_id);\n"})}),"\n",(0,d.jsx)(s.h2,{id:"row-level-security",children:"Row Level Security"}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-sql",children:'-- Profiles: users can only read/update their own\nALTER TABLE profiles ENABLE ROW LEVEL SECURITY;\n\nCREATE POLICY "Users can view own profile"\n  ON profiles FOR SELECT\n  USING (auth.uid() = id);\n\nCREATE POLICY "Users can update own profile"\n  ON profiles FOR UPDATE\n  USING (auth.uid() = id);\n\n-- Game sessions: users can only access their own\nALTER TABLE game_sessions ENABLE ROW LEVEL SECURITY;\n\nCREATE POLICY "Users can view own sessions"\n  ON game_sessions FOR SELECT\n  USING (auth.uid() = player_id);\n\nCREATE POLICY "Users can insert own sessions"\n  ON game_sessions FOR INSERT\n  WITH CHECK (auth.uid() = player_id);\n'})}),"\n",(0,d.jsx)(s.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,d.jsxs)(s.ul,{children:["\n",(0,d.jsx)(s.li,{children:(0,d.jsx)(s.a,{href:"/docs/guides/data/database-guide",children:"Database User Guide"})}),"\n",(0,d.jsx)(s.li,{children:(0,d.jsx)(s.a,{href:"/docs/guides/data/species-database",children:"Species Database Implementation"})}),"\n",(0,d.jsx)(s.li,{children:(0,d.jsx)(s.a,{href:"/docs/guides/data/prisma-orm",children:"Prisma ORM Guide"})}),"\n"]})]})}function x(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,d.jsx)(s,{...e,children:(0,d.jsx)(h,{...e})}):h(e)}}}]);