"use strict";(globalThis.webpackChunkwiki=globalThis.webpackChunkwiki||[]).push([[16867],{5813(e,s,n){n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>c,default:()=>u,frontMatter:()=>t,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"guides/data/database-guide","title":"Database User Guide","description":"Working with Postgres tables and Drizzle queries","source":"@site/docs/guides/data/database-guide.md","sourceDirName":"guides/data","slug":"/guides/data/database-guide","permalink":"/phaser-june/docs/guides/data/database-guide","draft":false,"unlisted":false,"editUrl":"https://github.com/kc0588615/phaser-june/tree/main/wiki/docs/guides/data/database-guide.md","tags":[{"inline":true,"label":"guide","permalink":"/phaser-june/docs/tags/guide"},{"inline":true,"label":"database","permalink":"/phaser-june/docs/tags/database"},{"inline":true,"label":"postgres","permalink":"/phaser-june/docs/tags/postgres"},{"inline":true,"label":"drizzle","permalink":"/phaser-june/docs/tags/drizzle"}],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1,"title":"Database User Guide","description":"Working with Postgres tables and Drizzle queries","tags":["guide","database","postgres","drizzle"]},"sidebar":"docsSidebar","previous":{"title":"Species List Improvements","permalink":"/phaser-june/docs/guides/ui/species-list-improvements"},"next":{"title":"Species Database","permalink":"/phaser-june/docs/guides/data/species-database"}}');var r=n(74848),a=n(28453);const t={sidebar_position:1,title:"Database User Guide",description:"Working with Postgres tables and Drizzle queries",tags:["guide","database","postgres","drizzle"]},c="Database User Guide",d={},l=[{value:"Conventions",id:"conventions",level:2},{value:"Drizzle Client Setup",id:"drizzle-client-setup",level:2},{value:"Querying Species",id:"querying-species",level:2},{value:"By Location (Raw SQL for PostGIS)",id:"by-location-raw-sql-for-postgis",level:3},{value:"By ID",id:"by-id",level:3},{value:"Search by Name",id:"search-by-name",level:3},{value:"Recording Game Data",id:"recording-game-data",level:2},{value:"Start Session",id:"start-session",level:3},{value:"Record Discovery",id:"record-discovery",level:3},{value:"React Query Integration",id:"react-query-integration",level:2},{value:"Related",id:"related",level:2}];function o(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"database-user-guide",children:"Database User Guide"})}),"\n",(0,r.jsx)(s.p,{children:"Practical guide for querying species data and recording player progress."}),"\n",(0,r.jsx)(s.h2,{id:"conventions",children:"Conventions"}),"\n",(0,r.jsxs)(s.p,{children:["App-owned tables follow these standards (import-owned tables like ",(0,r.jsx)(s.code,{children:"icaa"})," may differ):"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Naming"}),": snake_case; tables plural, columns singular"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Primary keys"}),": ",(0,r.jsx)(s.code,{children:"bigint GENERATED ALWAYS AS IDENTITY"})," (UUID only for external IDs)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Timestamps"}),": ",(0,r.jsx)(s.code,{children:"timestamptz"})," with ",(0,r.jsx)(s.code,{children:"_at"})," suffix"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Booleans"}),": ",(0,r.jsx)(s.code,{children:"is_"})," or ",(0,r.jsx)(s.code,{children:"has_"})," prefix"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Types"}),": ",(0,r.jsx)(s.code,{children:"text"})," (not varchar), ",(0,r.jsx)(s.code,{children:"jsonb"})," (not json)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Indexes"}),": ",(0,r.jsx)(s.code,{children:"ix_tablename_columns"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Unique"}),": ",(0,r.jsx)(s.code,{children:"uq_tablename_columns"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Foreign keys"}),": ",(0,r.jsx)(s.code,{children:"fk_tablename_reference"})]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["See ",(0,r.jsx)(s.a,{href:"https://github.com/your-repo/docs/DATABASE_USER_GUIDE.md#conventions-and-best-practices",children:"full conventions in docs/DATABASE_USER_GUIDE.md"}),"."]}),"\n",(0,r.jsx)(s.h2,{id:"drizzle-client-setup",children:"Drizzle Client Setup"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-typescript",children:"// src/db/index.ts\nimport { db } from '@/db';\n"})}),"\n",(0,r.jsx)(s.h2,{id:"querying-species",children:"Querying Species"}),"\n",(0,r.jsx)(s.h3,{id:"by-location-raw-sql-for-postgis",children:"By Location (Raw SQL for PostGIS)"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-typescript",children:"// src/lib/speciesQueries.ts\nimport { sql } from 'drizzle-orm';\nimport { db } from '@/db';\n\n// Use the get_species_in_radius function with table alias\nconst species = await db.execute(sql`\n  SELECT r.ogc_fid, r.comm_name, r.sci_name\n  FROM public.get_species_in_radius(${lon}, ${lat}, ${radiusMeters}) r\n`);\n"})}),"\n",(0,r.jsx)(s.h3,{id:"by-id",children:"By ID"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-typescript",children:"import { eq } from 'drizzle-orm';\nimport { db, icaa } from '@/db';\n\nconst [species] = await db\n  .select()\n  .from(icaa)\n  .where(eq(icaa.ogcFid, speciesId))\n  .limit(1);\n"})}),"\n",(0,r.jsx)(s.h3,{id:"search-by-name",children:"Search by Name"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-typescript",children:"import { ilike, or } from 'drizzle-orm';\nimport { db, icaa } from '@/db';\n\nconst results = await db\n  .select({\n    ogc_fid: icaa.ogcFid,\n    comm_name: icaa.commName,\n    sci_name: icaa.sciName,\n  })\n  .from(icaa)\n  .where(\n    or(\n      ilike(icaa.commName, `%${searchTerm}%`),\n      ilike(icaa.sciName, `%${searchTerm}%`)\n    )\n  )\n  .limit(10);\n"})}),"\n",(0,r.jsx)(s.h2,{id:"recording-game-data",children:"Recording Game Data"}),"\n",(0,r.jsx)(s.h3,{id:"start-session",children:"Start Session"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-typescript",children:"import { startGameSession } from '@/lib/playerTracking';\n\nconst sessionId = await startGameSession(userId);\n"})}),"\n",(0,r.jsx)(s.h3,{id:"record-discovery",children:"Record Discovery"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-typescript",children:"import { trackSpeciesDiscovery } from '@/lib/playerTracking';\n\nawait trackSpeciesDiscovery(userId, speciesId, {\n  sessionId,\n  cluesUnlockedBeforeGuess: clueCount,\n  incorrectGuessesCount: attempts,\n  scoreEarned: score\n});\n"})}),"\n",(0,r.jsx)(s.h2,{id:"react-query-integration",children:"React Query Integration"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-typescript",children:"// src/hooks/useSpeciesData.ts\nimport { useQuery } from '@tanstack/react-query';\n\nexport function useSpeciesAtLocation(lon: number, lat: number) {\n  return useQuery({\n    queryKey: ['species', lon, lat],\n    queryFn: () => getSpeciesAtLocation(lon, lat),\n    enabled: !!lon && !!lat\n  });\n}\n"})}),"\n",(0,r.jsx)(s.h2,{id:"related",children:"Related"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"/docs/reference/database-schema",children:"Database Schema Reference"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"/docs/guides/data/species-database",children:"Species Database Implementation"})}),"\n"]})]})}function u(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},28453(e,s,n){n.d(s,{R:()=>t,x:()=>c});var i=n(96540);const r={},a=i.createContext(r);function t(e){const s=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(a.Provider,{value:s},e.children)}}}]);